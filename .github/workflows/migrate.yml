name: Database Migration

on:
  push:
    branches: [main]
    paths:
      - 'src/MockOpenIdProvider/Migrations/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - production

env:
  DOTNET_VERSION: '9.0.x'

jobs:
  migrate:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Add GitHub Packages source with credentials
      run: |
        dotnet nuget remove source github || true
        dotnet nuget add source https://nuget.pkg.github.com/EcAuth/index.json \
          --name github \
          --username ${{ github.actor }} \
          --password ${{ secrets.ORG_PAT }} \
          --store-password-in-clear-text

    - name: Restore EF Core tools
      run: dotnet tool restore

    - name: Restore dependencies
      run: dotnet restore src/MockOpenIdProvider/MockOpenIdProvider.csproj

    - name: Build
      run: dotnet build src/MockOpenIdProvider/MockOpenIdProvider.csproj --no-restore

    # dev 環境: 既存の GitHub Secrets を使用
    - name: Run database migrations (dev)
      if: github.event.inputs.environment == 'dev' || github.event.inputs.environment == ''
      env:
        ConnectionStrings__MockIdpDbContext: ${{ secrets.AZURE_SQL_CONNECTION_STRING }}
        MOCK_IDP_DEFAULT_CLIENT_ID: ${{ vars.MOCK_IDP_DEFAULT_CLIENT_ID || 'mockclientid' }}
        MOCK_IDP_DEFAULT_CLIENT_SECRET: ${{ secrets.MOCK_IDP_DEFAULT_CLIENT_SECRET || 'mock-client-secret' }}
        MOCK_IDP_DEFAULT_CLIENT_NAME: ${{ vars.MOCK_IDP_DEFAULT_CLIENT_NAME || 'MockClient' }}
        MOCK_IDP_DEFAULT_USER_EMAIL: ${{ vars.MOCK_IDP_DEFAULT_USER_EMAIL || 'defaultuser@example.com' }}
        MOCK_IDP_DEFAULT_USER_PASSWORD: ${{ secrets.MOCK_IDP_DEFAULT_USER_PASSWORD || 'password' }}
        DEFAULT_ORGANIZATION_REDIRECT_URI: ${{ vars.DEFAULT_ORGANIZATION_REDIRECT_URI || 'https://localhost:8081/auth/callback' }}
        MOCK_IDP_FEDERATE_CLIENT_ID: ${{ vars.MOCK_IDP_FEDERATE_CLIENT_ID || 'federateclientid' }}
        MOCK_IDP_FEDERATE_CLIENT_SECRET: ${{ secrets.MOCK_IDP_FEDERATE_CLIENT_SECRET || 'federate-client-secret' }}
        MOCK_IDP_FEDERATE_CLIENT_NAME: ${{ vars.MOCK_IDP_FEDERATE_CLIENT_NAME || 'FederateClient' }}
        MOCK_IDP_FEDERATE_USER_EMAIL: ${{ vars.MOCK_IDP_FEDERATE_USER_EMAIL || 'federateuser@example.com' }}
      run: |
        cd src/MockOpenIdProvider
        dotnet ef database update --verbose

    # staging 環境: 1Password からシークレットを取得
    - name: Load secrets from 1Password (staging)
      if: github.event.inputs.environment == 'staging'
      uses: 1password/load-secrets-action@v2
      with:
        export-env: true
      env:
        OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN_NONPROD }}
        # Database credentials (ecauth-dev-sql は MockIdP も使用)
        SQL_HOST: op://EcAuth/ecauth-dev-sql/hostname
        SQL_DATABASE: op://EcAuth/ecauth-dev-sql/database
        SQL_USERNAME: op://EcAuth/ecauth-dev-sql/username
        SQL_PASSWORD: op://EcAuth/ecauth-dev-sql/password
        # Staging client/user credentials
        MOCKIDP_STAGING_CLIENT_ID: op://EcAuth/mockidp-staging/default_client_id
        MOCKIDP_STAGING_CLIENT_SECRET: op://EcAuth/mockidp-staging/default_client_secret
        MOCKIDP_STAGING_USER_EMAIL: op://EcAuth/mockidp-staging/default_user_email
        MOCKIDP_STAGING_USER_PASSWORD: op://EcAuth/mockidp-staging/default_user_password
        MOCKIDP_STAGING_REDIRECT_URI: op://EcAuth/mockidp-staging/redirect_uri

    - name: Run database migrations (staging)
      if: github.event.inputs.environment == 'staging'
      env:
        MOCKIDP_STAGING_CLIENT_NAME: StagingClient
      run: |
        # 接続文字列を組み立て
        export ConnectionStrings__MockIdpDbContext="Server=tcp:${SQL_HOST},1433;Initial Catalog=${SQL_DATABASE};User ID=${SQL_USERNAME};Password=${SQL_PASSWORD};Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;"
        cd src/MockOpenIdProvider
        dotnet ef database update --verbose

    # production 環境: 1Password (Prod) からシークレットを取得
    - name: Load secrets from 1Password (production)
      if: github.event.inputs.environment == 'production'
      uses: 1password/load-secrets-action@v2
      with:
        export-env: true
      env:
        OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN_PROD }}
        SQL_HOST: op://EcAuth/ecauth-prod-sql/hostname
        SQL_DATABASE: op://EcAuth/ecauth-prod-sql/database
        SQL_USERNAME: op://EcAuth/ecauth-prod-sql/username
        SQL_PASSWORD: op://EcAuth/ecauth-prod-sql/password

    - name: Run database migrations (production)
      if: github.event.inputs.environment == 'production'
      run: |
        # 接続文字列を組み立て
        export ConnectionStrings__MockIdpDbContext="Server=tcp:${SQL_HOST},1433;Initial Catalog=${SQL_DATABASE};User ID=${SQL_USERNAME};Password=${SQL_PASSWORD};Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;"
        cd src/MockOpenIdProvider
        dotnet ef database update --verbose

    - name: Verify migration
      if: github.event.inputs.environment == 'dev' || github.event.inputs.environment == ''
      env:
        ConnectionStrings__MockIdpDbContext: ${{ secrets.AZURE_SQL_CONNECTION_STRING }}
      run: |
        cd src/MockOpenIdProvider
        dotnet ef migrations list
