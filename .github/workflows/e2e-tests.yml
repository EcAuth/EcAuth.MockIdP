name: Playwright E2E Tests - MockOpenIdProvider

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      DB_PASSWORD: YourStrong@Passw0rd

    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          SA_PASSWORD: ${{ env.DB_PASSWORD }}
          ACCEPT_EULA: "Y"
        ports:
          - 1433:1433
        options: >-
          --health-cmd "exit 0"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      # 環境変数設定
      - name: Load environment variables from .env.dist
        run: |
          grep -v '^#' .env.dist | grep -v '^$' >> $GITHUB_ENV
      - run: echo "DB_HOST=localhost" >> $GITHUB_ENV
      - run: echo "ConnectionStrings__MockIdpDbContext=Server=${DB_HOST};Database=${MOCK_IDP_DB_NAME};User Id=${DB_USER};Password=${DB_PASSWORD};TrustServerCertificate=true;MultipleActiveResultSets=true" >> $GITHUB_ENV

      # E2Eテスト用環境変数
      - run: echo "MOCK_IDP_BASE_URL=https://localhost:9091" >> $GITHUB_ENV
      - run: echo "CLIENT_ID=mockclientid" >> $GITHUB_ENV
      - run: echo "CLIENT_SECRET=mock-client-secret" >> $GITHUB_ENV
      - run: echo "REDIRECT_URI=https://localhost:8081/auth/callback" >> $GITHUB_ENV
      - run: echo "TEST_USER_EMAIL=defaultuser@example.com" >> $GITHUB_ENV
      - run: echo "TEST_USER_PASSWORD=password" >> $GITHUB_ENV

      - name: Set up .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '9.0.x'

      - name: Add GitHub Packages source with credentials
        run: |
          dotnet nuget remove source github || true
          dotnet nuget add source https://nuget.pkg.github.com/EcAuth/index.json \
            --name github \
            --username ${{ github.actor }} \
            --password ${{ secrets.ORG_PAT }} \
            --store-password-in-clear-text

      - name: Restore .NET tools
        run: dotnet tool restore

      - name: Install dependencies
        run: dotnet restore ./EcAuth.MockIdP.sln

      - name: Build MockOpenIdProvider
        run: dotnet build --no-restore --configuration Release src/MockOpenIdProvider

      - name: Verify environment variables
        run: |
          echo "DB_HOST: ${DB_HOST}"
          echo "MOCK_IDP_DB_NAME: ${MOCK_IDP_DB_NAME}"
          echo "DB_USER: ${DB_USER}"
          echo "ConnectionString: ${ConnectionStrings__MockIdpDbContext}"

      - name: Migrate MockOpenIdProvider DB
        working-directory: src/MockOpenIdProvider
        run: dotnet ef database update

      - name: Generate development HTTPS certificate
        run: |
          mkdir -p ${HOME}/.aspnet/https
          dotnet dev-certs https -ep ${HOME}/.aspnet/https/aspnetapp.pfx -p changeit --trust
          echo "ASPNETCORE_Kestrel__Certificates__Default__Path=${HOME}/.aspnet/https/aspnetapp.pfx" >> $GITHUB_ENV
          echo "ASPNETCORE_Kestrel__Certificates__Default__Password=changeit" >> $GITHUB_ENV

      - name: Start MockOpenIdProvider
        run: |
          export ASPNETCORE_HTTPS_PORT=9091
          export ASPNETCORE_URLS="https://0.0.0.0:9091"
          dotnet run --project src/MockOpenIdProvider --configuration Release --urls "https://0.0.0.0:9091" &
        env:
          ASPNETCORE_ENVIRONMENT: Development

      - name: Wait for MockOpenIdProvider to be ready
        run: |
          for i in {1..30}; do
            if curl -k https://localhost:9091/health 2>/dev/null; then
              echo "MockOpenIdProvider is ready"
              break
            fi
            echo "Waiting for MockOpenIdProvider to start... ($i/30)"
            sleep 2
          done

      - name: Install Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 22

      - name: Install Playwright
        working-directory: e2e-tests
        run: |
          npm install
          npx playwright install --with-deps chromium

      - name: Run Playwright E2E Tests
        working-directory: e2e-tests
        run: npx playwright test

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: 'e2e-tests/test-results/'

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: 'e2e-tests/playwright-report/'

      - name: Display MockOpenIdProvider logs
        if: failure()
        run: cat src/MockOpenIdProvider/logs/*.log || echo "No logs found"
